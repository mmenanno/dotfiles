name: Lint

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  lint-and-security:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      statuses: write
      pull-requests: write
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Super Linter
        uses: super-linter/super-linter@v8.3.0
        env:
          VALIDATE_ALL_CODEBASE: false
          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VALIDATE_BASH: true
          VALIDATE_MARKDOWN: true
          VALIDATE_YAML: true
          VALIDATE_GITHUB_ACTIONS: true

      - name: TruffleHog
        uses: trufflesecurity/trufflehog@v3.92.3
        with:
          extra_args: --results=verified,unknown

      - name: LFS Warning
        if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
        uses: ppremk/lfs-warning@v3.3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check executable permissions
        run: |
          missing=$(find . -name "*.sh" -type f -not -executable -print)
          if [ -n "$missing" ]; then
            while IFS= read -r file; do
              printf 'Missing +x: %s\n' "$file"
            done <<< "$missing"
            exit 1
          fi

      - name: TODO to Issue
        uses: alstr/todo-to-issue-action@v5.1.13
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  nix-verification:
    runs-on: ubuntu-latest
    env:
      NIX_CONFIG: |
        experimental-features = nix-command flakes
        access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install Nix
        uses: cachix/install-nix-action@v31

      - name: Flake checker
        uses: DeterminateSystems/flake-checker-action@v12
        with:
          flake-lock-path: ./nix/flake.lock
          ignore-missing-flake-lock: false

      - name: Check nix flake evaluation
        run: nix flake check ./nix --no-build

      - name: Static analysis with statix
        run: nix run nixpkgs#statix -- check ./nix

      - name: Find dead code with deadnix
        run: nix run nixpkgs#deadnix -- --fail ./nix
