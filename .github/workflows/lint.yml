name: Lint

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup linting tools
        run: |
          # Install shellcheck for shell script linting
          sudo apt-get update
          sudo apt-get install -y shellcheck
          
          # Install markdownlint-cli for markdown linting
          npm install -g markdownlint-cli

      - name: Lint shell scripts
        run: |
          echo "üîç Linting shell scripts..."
          find . -name "*.sh" -type f -exec shellcheck {} +
          # Also lint scripts without .sh extension
          shellcheck bin/nixup-with-secrets

      - name: Lint Nix files
        run: |
          echo "üîç Linting Nix files..."
          # Check Nix syntax and formatting
          find . -name "*.nix" -type f -exec nix-instantiate --parse {} \; > /dev/null
          
          # Use nixfmt if available (best effort)
          if command -v nixfmt &> /dev/null; then
            find . -name "*.nix" -type f -exec nixfmt --check {} +
          else
            echo "nixfmt not available, skipping format check"
          fi

      - name: Lint markdown files  
        run: |
          echo "üîç Linting markdown files..."
          markdownlint "**/*.md"

      - name: Lint GitHub workflow files
        run: |
          echo "üîç Linting GitHub workflow files..."
          # Basic YAML syntax check for workflow files only
          for file in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [ -f "$file" ]; then
              echo "Checking $file"
              # Basic YAML syntax validation using Python
              python3 -c "import yaml; yaml.safe_load(open('$file'))" || exit 1
            fi
          done

      - name: Check for common issues
        run: |
          echo "üîç Checking for common issues..."
          
          # Check for TODO/FIXME comments
          echo "Checking for TODO/FIXME comments..."
          grep -r "TODO\|FIXME" --exclude-dir=.git . || echo "No TODO/FIXME found"
          
          # Check for hardcoded secrets patterns
          echo "Checking for potential hardcoded secrets..."
          if grep -r -i "password\|secret\|key\|token" --include="*.nix" --include="*.sh" . | grep -v "op://" | grep -v "# "; then
            echo "‚ö†Ô∏è  Found potential hardcoded secrets - please review"
            exit 1
          else
            echo "‚úÖ No hardcoded secrets detected"
          fi
          
          # Check for large files
          echo "Checking for large files (>1MB)..."
          find . -type f -size +1M -not -path "./.git/*" | while read -r file; do
            echo "‚ö†Ô∏è  Large file detected: $file"
          done
          
          # Check file permissions
          echo "Checking executable permissions..."
          find . -name "*.sh" -not -executable -type f | while read -r file; do
            echo "‚ö†Ô∏è  Shell script without executable permission: $file"
          done

      - name: Summary
        run: |
          echo "‚úÖ Linting completed successfully!"
          echo ""
          echo "Checked:"
          echo "- Shell scripts (shellcheck)"
          echo "- Nix files (syntax validation)"
          echo "- Markdown files (markdownlint)"
          echo "- GitHub workflows (YAML syntax)"
          echo "- Security patterns"
          echo "- File permissions"