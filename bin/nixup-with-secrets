#!/bin/bash
# Enhanced nixup script with bootstrap support and 1Password integration

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    echo -e "${BLUE}ðŸ”§${NC} $1"
}

print_success() {
    echo -e "${GREEN}âœ…${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸${NC} $1"
}

print_error() {
    echo -e "${RED}âŒ${NC} $1"
}

print_bootstrap() {
    echo -e "${BLUE}ðŸš€${NC} $1"
}

# Function to check if this is a fresh system
is_fresh_system() {
    # Check if 1Password CLI is available
    if ! command -v op >/dev/null 2>&1; then
        return 0  # Fresh system - 1Password CLI not installed
    fi
    return 1  # Not fresh - 1Password CLI exists
}

# Function to run bootstrap
run_bootstrap() {
    print_bootstrap "Fresh system detected - running bootstrap mode"
    print_status "This will install 1Password CLI and other essentials..."

    export NIX_BOOTSTRAP_MODE=1

    # Run darwin-rebuild in bootstrap mode
    if sudo -E darwin-rebuild switch --flake ~/dotfiles/nix#macbook_setup --impure "$@"; then
        print_success "Bootstrap complete!"
        echo ""
        print_status "Next steps:"
        echo "1. Launch 1Password app and sign in"
        echo "2. Enable 1Password CLI: 1Password â†’ Settings â†’ Developer â†’ Command Line Interface"
        echo "3. Sign into 1Password CLI: ${BLUE}op signin${NC}"
        echo "4. Run '${BLUE}nixup${NC}' again to load your personal configuration"
        echo ""
    else
        print_error "Bootstrap failed!"
        exit 1
    fi
}

# Function to extract field from 1Password item JSON
extract_field() {
    local json="$1"
    local field_name="$2"
    echo "$json" | jq -r --arg field "$field_name" '.fields[]? | select(.label == $field) | .value // empty'
}

# Function to load secrets
load_secrets() {
    if ! command -v op >/dev/null 2>&1; then
        print_error "1Password CLI not found (this shouldn't happen after bootstrap)"
        return 1
    fi

    if ! command -v jq >/dev/null 2>&1; then
        print_error "jq not found (required for parsing 1Password items)"
        return 1
    fi

    # Check if signed in
    if ! op account list >/dev/null 2>&1; then
        print_error "Not signed into 1Password"
        echo "Run: ${BLUE}op signin${NC}"
        return 1
    fi

    print_status "Loading secrets from 1Password..."

    # Fetch all items in parallel for efficiency
    local main_id_json server_json private_id_json ssh_json git_config_json
    
    print_status "Fetching 1Password items..."
    main_id_json="$(op item get "MainID" --vault="Nix" --format=json 2>/dev/null || echo '{}')"
    server_json="$(op item get "Server" --vault="Nix" --format=json 2>/dev/null || echo '{}')"
    private_id_json="$(op item get "PrivateID" --vault="Nix" --format=json 2>/dev/null || echo '{}')"
    ssh_json="$(op item get "SSH" --vault="Nix" --format=json 2>/dev/null || echo '{}')"
    git_config_json="$(op item get "Git Config" --vault="Nix" --format=json 2>/dev/null || echo '{}')"

    # Define secrets configuration: VAR_NAME|ITEM_JSON_VAR|FIELD_NAME|DESCRIPTION|REQUIRED
    local secrets=(
        "NIX_PERSONAL_EMAIL|main_id_json|github_email|email configuration|true"
        "NIX_GITHUB_USER|main_id_json|github_user|GitHub user configuration|true"
        "NIX_SIGNING_KEY|main_id_json|signing_key|signing key configuration|true"
        "NIX_SSH_MAIN_GITHUB_KEY|main_id_json|ssh_key|main SSH key configuration|true"
        "NIX_SSH_MAIN_GITHUB_KEYFILE|main_id_json|github_keyfile|main GitHub keyfile name|true"
        "NIX_LAPTOP_NAME|main_id_json|laptop_name|laptop name configuration|true"
        "NIX_FULL_NAME|main_id_json|name_full|full name configuration|true"
        "NIX_SERVER_IP_MAIN|server_json|main_ip|server IP configurations|true"
        "NIX_SERVER_IP_NVM|server_json|nvm_ip|server IP configurations|false"
        "NIX_SERVER_NAME_L|server_json|name_l|server name configuration|false"
        "NIX_SERVER_NVM_NAME|server_json|nvm_name|NVM server name configuration|false"
        "NIX_SSH_MAIN_SERVER_KEYFILE|server_json|main_server_keyfile|main server keyfile name|false"
        "NIX_SSH_NVM_SERVER_KEYFILE|server_json|nvm_server_keyfile|NVM server keyfile name|false"
        "NIX_PRIVATE_EMAIL|private_id_json|ssh_email|private SSH email configuration|false"
        "NIX_PRIVATE_USER|private_id_json|user|private user configuration|false"
        "NIX_PRIVATE_USER_SHORT|private_id_json|user_short|private user short name|false"
        "NIX_PRIVATE_SIGNING_KEY|private_id_json|signing_key|private ID configuration|false"
        "NIX_PRIVATE_GITDIR|private_id_json|gitdir|private ID configuration|false"
        "NIX_SSH_PRIVATE_GITHUB_KEY|private_id_json|ssh_key|private SSH key configuration|false"
        "NIX_SSH_PRIVATE_GITHUB_KEYFILE|private_id_json|github_keyfile|private GitHub keyfile name|false"
        "NIX_SSH_MAIN_SERVER_KEY|ssh_json|unraid_key|main server SSH key configuration|false"
        "NIX_SSH_NVM_SERVER_KEY|ssh_json|nvm_key|NVM server SSH key configuration|false"
        "NIX_FORGEJO_DOMAIN|git_config_json|forgejo_domain|forgejo domain configuration|false"
    )

    local secrets_loaded=0
    local private_secrets=0
    local private_loaded=0

    # Load and validate each secret
    for secret_config in "${secrets[@]}"; do
        IFS='|' read -r var_name item_var field_name description required <<< "$secret_config"
        
        # Get the JSON for this item
        local item_json_value
        case "$item_var" in
            "main_id_json") item_json_value="$main_id_json" ;;
            "server_json") item_json_value="$server_json" ;;
            "private_id_json") item_json_value="$private_id_json" ;;
            "ssh_json") item_json_value="$ssh_json" ;;
            "git_config_json") item_json_value="$git_config_json" ;;
            *) item_json_value="{}" ;;
        esac
        
        # Extract the field value
        local value
        value="$(extract_field "$item_json_value" "$field_name")"
        export "$var_name=$value"
        
        # Validate and report
        if [[ -n "$value" ]]; then
            print_success "Loaded $description"
            ((secrets_loaded++))
            
            # Track private ID secrets specifically
            if [[ "$var_name" =~ ^NIX_PRIVATE_ ]]; then
                ((private_loaded++))
            fi
        else
            if [[ "$required" == "true" ]]; then
                print_warning "Could not load $description from 1Password"
            else
                print_warning "Could not load $description from 1Password (optional)"
            fi
        fi
        
        # Count total private secrets
        if [[ "$var_name" =~ ^NIX_PRIVATE_ ]]; then
            ((private_secrets++))
        fi
    done

    # Special validation for complete private ID configuration
    if [[ $private_loaded -eq $private_secrets && $private_secrets -gt 0 ]]; then
        print_success "Complete private ID configuration loaded"
    fi

    # Final validation
    if [[ $secrets_loaded -eq 0 ]]; then
        print_error "No secrets loaded from 1Password"
        print_status "Check your 1Password items:"
        echo "  - Nix/MainID/github_email"
        echo "  - Nix/MainID/github_user"
        echo "  - Nix/MainID/signing_key"
        echo "  - Nix/MainID/ssh_key"
        echo "  - Nix/MainID/github_keyfile"
        echo "  - Nix/MainID/laptop_name"
        echo "  - Nix/MainID/name_full"
        echo "  - Nix/Server/main_ip"
        echo "  - Nix/Server/nvm_ip (optional)"
        echo "  - Nix/Server/name_l (optional)"
        echo "  - Nix/Server/nvm_name (optional)"
        echo "  - Nix/Server/main_server_keyfile (optional)"
        echo "  - Nix/Server/nvm_server_keyfile (optional)"
        echo "  - Nix/PrivateID/ssh_email (optional)"
        echo "  - Nix/PrivateID/user (optional)"
        echo "  - Nix/PrivateID/user_short (optional)"
        echo "  - Nix/PrivateID/signing_key (optional)"
        echo "  - Nix/PrivateID/ssh_key (optional)"
        echo "  - Nix/PrivateID/github_keyfile (optional)"
        echo "  - Nix/PrivateID/gitdir (optional)"
        echo "  - Nix/SSH/unraid_key (optional)"
        echo "  - Nix/SSH/nvm_key (optional)"
        echo "  - Nix/Git Config/forgejo_domain (optional)"
        return 1
    fi

    return 0
}

# Main execution logic
main() {
    echo "ðŸ  Nix Dotfiles Configuration Manager"
    echo "======================================"

    if is_fresh_system; then
        run_bootstrap "$@"
    else
        if load_secrets; then
            print_status "Applying configuration with secrets..."
            if sudo -E darwin-rebuild switch --flake ~/dotfiles/nix#macbook_setup --impure "$@"; then
                print_success "Configuration applied successfully!"
            else
                print_error "Configuration build failed!"
                exit 1
            fi
        else
            print_error "Failed to load secrets. Configuration not applied."
            echo ""
            print_status "You can still run in bootstrap mode with:"
            echo "  ${BLUE}NIX_BOOTSTRAP_MODE=1 sudo -E darwin-rebuild switch --flake ~/dotfiles/nix#macbook_setup --impure${NC}"
            exit 1
        fi
    fi
}

# Run main function with all arguments
main "$@"
