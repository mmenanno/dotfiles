# Dotfiles Repository - AI Agent Execution Playbook

This file defines repository-specific executable constraints and validation workflows for AI programming assistants working on this Nix dotfiles configuration. It extends the global AGENTS.md with dotfiles-specific requirements.

## Mandatory Validation Commands

Before any code changes are submitted or merged, AI agents MUST execute these validation commands:

### Build & Check Commands

```bash
# Validate Nix configuration
nx check

# Build configuration (dry-run)
nx build
```

### Linting & Style Checks

```bash
# Shell script validation
shellcheck bin/*

# Markdown linting
markdownlint **/*.md
```

### Testing Commands

```bash
# No specific test commands for this infrastructure repo
# Individual projects should define their own test suites
```

## Code Style Guidelines

### Nix Configuration

- Use 2-space indentation
- Create small, focused modules
- Use hyphenated filenames (e.g., `system-defaults.nix`)
- Group related imports together
- Add comments for complex configurations

### Shell Scripts

- Use `#!/bin/bash` shebang
- Include `set -euo pipefail` for safety
- Must pass `shellcheck` validation
- Use lowercase, short names (e.g., `nx`, `gbclean`)
- **1Password Plugin Pattern**: When using CLI tools (like `gh`) that have 1Password plugin support in non-interactive subshells, wrap commands with `op plugin run --` to ensure proper authentication. Example: `op plugin run -- gh repo view`

### Markdown Documentation

- Keep sections concise and scannable
- Must pass `markdownlint` validation
- Use consistent heading hierarchy

## PR Validation Requirements

All AI-generated pull requests MUST:

1. **Pass all validation commands** listed above
2. **Use conventional commits**: `feat:`, `fix:`, `refactor:`, etc.
3. **Include clear descriptions** with rationale and before/after notes
4. **Update documentation** when adding new modules or functionality
5. **Pass CI workflows** in `.github/workflows/lint.yml`

## Prohibited Operations

AI agents are PROHIBITED from executing these dangerous operations:

- `rm -rf` or other destructive file operations
- `sudo` commands that modify system state
- Database migrations or data modifications
- External API calls with `curl`/`wget` to unknown endpoints
- Deployment commands
- Operations that modify production environments

## Allowed Operations

AI agents MAY execute these safe, idempotent operations:

- Configuration validation (`nx check`)
- Linting and style checks
- Build operations that don't modify system state
- File reading operations
- Git status and diff operations
- Documentation generation

## Security Requirements

- No secrets in repository files
- Use 1Password CLI for secret management
- All configuration changes require code review
- Maintain principle of least privilege for AI operations

### 1Password CLI Integration

This repository uses 1Password CLI plugins for secure credential management. When writing shell scripts:

1. **Aliases don't work in subshells**: Shell aliases (like `alias gh="op plugin run -- gh"`) don't inherit into non-interactive subshells used by scripts
2. **Explicit wrapping required**: In scripts that spawn subshells, explicitly wrap plugin-enabled commands:
   ```bash
   # ✅ CORRECT - Works in scripts and subshells
   gh_output=$(op plugin run -- gh repo view --json ...)

   # ❌ WRONG - Alias won't work in subshell
   gh_output=$(gh repo view --json ...)
   ```
3. **Plugin initialization**: Before using plugins, run `op plugin init <tool>` (e.g., `op plugin init gh`)
4. **Configuration location**: Plugin aliases are defined in `nix/modules/home/onepassword.nix`

For more details, see: https://developer.1password.com/docs/cli/shell-plugins/troubleshooting/#if-your-script-doesnt-inherit-shell-plugin-aliases

## Build System Commands

### Primary Commands

- `nx up` or `nixup`: Apply configuration changes
- `nx check` or `nx c`: Validate configuration
- `nx build` or `nx b`: Build without applying
- `nx diff` or `nx d`: Show pending changes

### Development Commands

- `nx edit` or `nixedit`: Open configuration in editor
- `nx status` or `nx s`: Show git status
- `nx clean` or `nx cl`: Clean old generations
- `nx help` or `nx h`: Show available commands

## Project Structure

- `nix/flake.nix`: Main configuration entry point
- `nix/modules/system/`: System-level configurations
- `nix/modules/home/`: User-level configurations
- `nix/modules/home/ai-globals.nix`: Global AI configuration generator
- `bin/`: Utility scripts and tools
- `.github/workflows/`: CI/CD automation

## AI Configuration System

This repository uses a hierarchical AI configuration system managed through Nix:

### Configuration Files

1. **Global configurations** (generated by `nix/modules/home/ai-globals.nix`):
   - `~/AGENTS.md`: Universal execution constraints (all AI tools)
   - `~/.claude/CLAUDE.md`: Claude-specific global preferences
   - `~/GEMINI.md`: Gemini-specific global preferences
   - `~/.cursor/rules/global-ai-integration.md`: Cursor global rules

2. **Project-specific configurations** (in repository root):
   - `AGENTS.md` (this file): Dotfiles-specific constraints
   - `CLAUDE.md`: Claude-specific dotfiles preferences

### Cursor Rules System

**IMPORTANT**: Cursor uses a **rules directory** (`~/.cursor/rules/`), not a `.cursorrules` file.

- Rules are markdown files in `~/.cursor/rules/`
- Global rules are managed by Nix via `ai-globals.nix`
- Each rule file has YAML frontmatter with metadata
- Rules can be scoped to specific file types or always active
- When adding rules, update `nix/modules/home/ai-globals.nix`, not individual files

Example rule structure:

```markdown
---
type: always
description: "Rule description"
---

# Rule Content
...
```
